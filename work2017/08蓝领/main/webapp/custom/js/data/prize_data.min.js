$(function(){function t(t){t?echarts.init(document.getElementById("type_rank"),theme).setOption(y):$("#type_rank").html("暂无数据")}function e(t){t?echarts.init(document.getElementById("city_rank"),theme).setOption(y):$("#city_rank").html("暂无数据")}function a(){function a(t){1==t.code?$("#draw_total").html(t.context.yDraw):alert(t.msg)}function i(e){1==e.code?(c.yAxis.data=e.context.x,c.series[0].data=e.context.yCnt,t(e.context.x.length>0?!0:!1)):alert(e.msg)}function n(t){1==t.code?(y.yAxis.data=t.context.x,y.series[0].data=t.context.yCnt,e(t.context.x.length>0?!0:!1)):alert(t.msg)}function m(t){for(var e=t.context.yAward,a="",i=0;i<e.length;i++)a+="<tr><td>"+e[i].productName+"</td><td>"+e[i].cnt+'</td><td data-productid="'+e[i].productId+'"></td><td>'+e[i].totalcnt+"</td></tr>";$(".prize-table tbody").html(a),$.ajax({type:"GET",url:" /api/v1/order/GetActivityPlan",data:{activity_id:d},success:function(t){ajaxResHandle(t,function(){for(var e=t.context.items,a=0,i=e.length;a<i;a++)$(".prize-table tbody").find('[data-productid="'+e[a].productId+'"]').html(e[a].quantity)})}})}$.ajax({type:"POST",url:"/api/v1/data/GetActivity",data:{activity_id:d},success:function(t){ajaxResHandle(t,a)}}),$.ajax({type:"POST",url:"/api/v1/data/GetAwardRank",data:data,success:function(t){ajaxResHandle(t,i)}}),$.ajax({type:"POST",url:"/api/v1/data/GetAwardRank",data:topn,success:function(t){ajaxResHandle(t,n)}}),$.ajax({type:"POST",url:"/api/v1/data/GetAwardList",data:prizeList,success:function(t){ajaxResHandle(t,m)}})}function i(t,e){var a,i,n;return a=t.split("-"),i=new Date(a[1]+"-"+a[2]+"-"+a[0]),a=e.split("-"),n=new Date(a[1]+"-"+a[2]+"-"+a[0]),parseInt(Math.abs(i-n)/1e3/60/60/24)}var n=location.search,m=/(\\?|\\&)activity_id=([^&?]*)/gi,d=n.match(m)?n.match(m).join("").replace("activity_id=",""):"";$("#type_scan").attr("href","/html/data/scan-data.html?activity_id="+d),$("#type_user").attr("href","/html/data/user-data.html?activity_id="+d);var r=(new Date).getTime(),o=moment(r).format("YYYY-MM-DD"),s=moment(r).subtract(1,"days").format("YYYY-MM-DD");data={activity_id:d,beginTime:new Date(s+" 00:00:00").getTime(),endTime:new Date(s+" 23:59:59").getTime(),topn:10,type:1},topn={activity_id:d,beginTime:new Date(s+" 00:00:00").getTime(),endTime:new Date(s+" 23:59:59").getTime(),topn:10,type:2},prizeList={activity_id:d,beginTime:new Date(s+" 00:00:00").getTime(),endTime:new Date(s+" 23:59:59").getTime(),topn:10},$(".time").html(o);var c={tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"value",boundaryGap:[0,.01]},yAxis:{type:"category",data:[]},series:[{name:"访问用户省市分布前10名",type:"bar",data:[]}]},y={tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"value",boundaryGap:[0,.01]},yAxis:{type:"category",data:[]},series:[{name:"访问用户省市分布前10名",type:"bar",data:[]}]};a(),$(".time_btn_box").on("click",function(){$(".time_box ul").show()}),$(".time_box ul").on("click",function(t){if(!$(t.target).hasClass(".active")){$(".time_box ul li").removeClass("active"),$(t.target).addClass("active"),$(".time_box ul").hide(),$(".time_item").html($(t.target).attr("tag")+"天");var e=null,i=null;switch($(t.target).attr("tag")){case"7":e=moment(r).subtract(7,"days").startOf("day").format("l"),i=moment(r).subtract(1,"days").endOf("day").format("l"),moment(r).subtract(14,"days").startOf("day").format("l"),moment(r).subtract(8,"days").endOf("day").format("l"),$(".time").html(moment(r).subtract(7,"days").startOf("day").format("YYYY-MM-DD")+"-"+moment(r).subtract(1,"days").endOf("day").format("YYYY-MM-DD"));break;case"1":e=moment(r).subtract(1,"days").startOf("day").format("l"),i=moment(r).subtract(1,"days").endOf("day").format("l"),moment(r).subtract(28,"days").startOf("day").format("l"),moment(r).subtract(15,"days").endOf("day").format("l"),$(".time").html(moment(r).subtract(1,"days").startOf("day").format("YYYY-MM-DD")+"-"+moment(r).subtract(1,"days").endOf("day").format("YYYY-MM-DD"));break;case"28":e=moment(r).subtract(28,"days").startOf("day").format("l"),i=moment(r).subtract(1,"days").endOf("day").format("l"),moment(r).subtract(56,"days").startOf("day").format("l"),moment(r).subtract(29,"days").endOf("day").format("l"),$(".time").html(moment(r).subtract(28,"days").startOf("day").format("YYYY-MM-DD")+"-"+moment(r).subtract(1,"days").endOf("day").format("YYYY-MM-DD"));break;case"all":$(".time_item").html("全部"),e=project_b_time+" 00:00:00",i=moment(r).endOf("day").format("l"),"","",$(".muted").html(project_b_time+"-"+o)}data={activity_id:d,beginTime:new Date(e).getTime(),endTime:new Date(i).getTime(),topn:10,type:1},topn={activity_id:d,beginTime:new Date(e).getTime(),endTime:new Date(i).getTime(),topn:10,type:2},prizeList={activity_id:d,beginTime:new Date(e).getTime(),endTime:new Date(i).getTime(),topn:10},a()}});var l=flatpickr(".flatpickr-input",{mode:"range",locale:"zh",dateFormat:"Y-m-d H:i",onClose:function(t,e,n){console.log(t);var m=l.formatDate(l.selectedDates[0],"Y-m-d H:i:S"),r=moment(l.selectedDates[1].getTime()).endOf("day").format("l"),o=l.formatDate(l.selectedDates[0],"Y-m-d"),s=l.formatDate(l.selectedDates[0],"Y-m-d");$(".flatpickr-input").val(l.formatDate(l.selectedDates[0],"Y-m-d H:i")+" 至 "+moment(l.selectedDates[1].getTime()).endOf("day").format("YYYY-MM-DD HH:mm"));var c=i(o,s);c>0?$(".time").html(o+" - "+s):$(".time").html(o);moment(m).subtract(c+1,"days").format("YYYY-MM-DD HH:mm:ss"),moment(r).subtract(c+1,"days").format("YYYY-MM-DD HH:mm:ss");data={activity_id:d,beginTime:new Date(m).getTime(),endTime:new Date(r).getTime(),topn:10,type:1},topn={activity_id:d,beginTime:new Date(m).getTime(),endTime:new Date(r).getTime(),topn:10,type:2},prizeList={activity_id:d,beginTime:new Date(m).getTime(),endTime:new Date(r).getTime(),topn:10},a()}})});