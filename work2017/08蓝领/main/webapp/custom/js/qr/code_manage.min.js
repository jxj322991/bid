function dropLoadInit(){obj.page=1,mainData.data.page=1,$(".dropload-down").show(),dropLoad.noData(!1),dropLoad.unlock(),dropLoad.resetload()}function compile(e){$('input[name="name"]').val(e.nameTxt),$('input[name="count"]').val(e.countTxt),$('input[name="count"]').attr("disabled",!0),$(".relevance-name").addClass("c-6"),$(".rules-text").addClass("c-6"),$(".relevance-name").text(e.relevance),$(".relevance-id").text(e.productId),$(".rules-text").text(e.rulesTxt),$('[data-click="form-down"]').click(function(){return!1}),$('textarea[name="remarks"]').val(e.remarksTxt),"否"===e.withPinPasswd?($(".code-checkes").addClass("invisible"),$(".menu_c div").removeClass("j_active"),$(".no_c").addClass("j_active"),$(".menu_c").addClass("disabled"),$(".code-check").removeClass("checked").addClass("disabled").children(".check").attr("checked",!1)):($(".code-checkes").removeClass("invisible"),$(".menu_c div").removeClass("j_active"),$(".yes_c").addClass("j_active"),$(".menu_c").addClass("disabled"),$(".code-check1").children(".check").val()==e.pinPasswdLength?($(".check").attr("checked",!1).parent(".code-check").removeClass("checked disabled"),$(".code-check1").addClass("checked disabled").children(".check").attr("checked",!0),$(".code-check2").addClass("disabled")):$(".code-check2").children(".check").val()==e.pinPasswdLength?($(".check").attr("checked",!1).parent(".code-check").removeClass("checked disabled"),$(".code-check2").addClass("checked disabled").children(".check").attr("checked",!0),$(".code-check1").addClass("disabled")):alert("aa")),$(".tip-url").html(e.domain),$(".pop").removeClass("invisible").children(".add-code").removeClass("invisible").siblings().addClass("invisible"),$(".add-btn").addClass("invisible").siblings(".compile-btn").removeClass("invisible"),isScrollable()}function isNecessary(e){e?($(".code-check").removeClass("checked").removeClass("disabled").children(".check").attr("checked",!1),$(".code-check2").addClass("checked").children(".check").attr("checked",!0),$(".code-checkes").removeClass("invisible")):($(".code-check").removeClass("checked").addClass("disabled").children(".check").attr("checked",!1),$(".code-checkes").addClass("invisible"))}function getproductList(){$.get("/api/v1/product/GetProductList",function(e){ajaxResHandle(e,function(){$("#relevance-product").html(tmpl("template_relevance",e.context)),$("#productid-list").prepend(tmpl("template_productlist",e.context))})})}function render(e,t){obj.page++,mainData.data.page++;var a=e.data;a.length>0?$("#code-list").append(tmpl("template_codelist",e)):(t.lock(),t.noData()),t.resetload(),2==mainData.data.page&&a.length<=0&&($(".dropload-down").hide(),$("#code-list").html('<div class="codelist-nodata_container">\n            <img src="//saascore.oss-cn-beijing.aliyuncs.com/mobile/custom/img/acms/nodata.png" alt="" class="codelist-img_nodata">\n            <div class="codelist-info_nodata">暂无数据</div>'))}function isScrollable(){$(".pop").hasClass("invisible")?$("html").removeClass("html-unscrollable"):$("html").addClass("html-unscrollable")}var withPinPasswd=!0,productId="",status="",batchno="",obj={page:1,size:20,productId:"",status:"",batchNo:"",numTxt:"",nameTxt:"",relevance:"",packageType:"",rulesTxt:"",countTxt:"",timeTxt:"",personTxt:"",withPinPasswd:"",remarksTxt:"",beginTime:"",endTime:"",domain:"",orgId:""},str="",mainData={url:"/func/qr/list/batch",method:"GET",data:{productId:obj.productId,page:obj.page,size:obj.size,status:obj.status,beginTime:obj.beginTime,endTime:obj.endTime}};$.get("/api/v1/es/GetOrgInfo",function(e){ajaxResHandle(e,function(){if(1===e.code){if(obj.orgId=e.context.orgId,!e.context.params["qr.domain"])return void $(".tip").addClass("invisible");var t=e.context.params["qr.domain"].value;t=t.split(",")[0],$(".tip-url").text(t),$(".tip").removeClass("invisible"),obj.domain=t}else alert(e.msg)})}),$(".nav-item .list").each(function(){$(this).children("li:last-child").addClass("active")}),$('[data-click="seek"]').click(function(){$(this).parent().hide()}),$('[data-click="add-enter"]').click(function(){$(".add-title").text("新增码包"),$('input[name="count"]').attr("disabled",!1),$(".add-code input").val(""),$(".code-check1 input").val(4),$(".code-check2 input").val(6),$(".add-code .relevance-name").text("关联产品"),$("#relevance-product li").removeClass("active"),$(".add-code .rules-text").text("产品规格"),$('textarea[name="remarks"]').val(""),withPinPasswd=!0,$(".menu_c").removeClass("disabled"),$(".menu_c div").removeClass("j_active"),$(".yes_c").addClass("j_active"),$(".relevance-name").removeClass("c-6"),$(".rules-text").removeClass("c-6"),$(".code-check").removeClass("checked disabled").children(".check").attr("checked",!1),$(".code-checkes").removeClass("invisibles"),$(".add-code .code-check1").addClass("checked").children().attr("checked",!0),$(".add-code .code-check2").removeClass("checked").children().attr("checked",!1),$(".pop").removeClass("invisible").children(".add-code").removeClass("invisible").siblings().addClass("invisible");var e=$.Event("shown.cj.modal",{relatedTarget:this});$(".pop").trigger(e),$(".compile-btn").addClass("invisible").siblings(".add-btn").removeClass("invisible"),isScrollable()}),$('[data-click="add-btn"]').click(function(){var e=$('input[name="name"]').val();if(""!==$.trim(e)){var t=$('input[name="count"]').val(),a=/^[0-9]*$/;if(""!==$.trim(t))if(parseInt(t)<1||parseInt(t)>3e6)alert("二维码数量必须在1-3000000之间");else if(a.test($.trim(t))){var s=$(".import").children(".relevance-id").text();if(""!==s){var i="盒"===$(".rules-text").text()?1:0,c=$('textarea[name="remarks"]').val(),d=$('input[name="code"]:checked').val()||0;console.log($('input[name="code"]:checked').val());var l=$(".tip-url").text();console.log(e+","+t+","+s+","+i+","+c+","+withPinPasswd+","+d),$.post("/api/v1/qr/CreateQrBatch",{productId:s,size:t,withPinPasswd:withPinPasswd,name:e,orgId:obj.orgId,pinPasswdLength:d,memo:c,domain:l,needGenerate:!0}).done(function(e){ajaxResHandle(e,function(){alert("新增成功！二维码生成需要一定的时间"),$("#code-list").html(""),dropLoadInit()})}),$(".pop").addClass("invisible").children(".void-code").addClass("invisible"),isScrollable()}else alert("请选择关联产品！")}else alert("二维码数量必须为数字！");else alert("请输入二维码数量！")}else alert("请输入码包名称！")}),$("#code-list").on("click",'[data-click="download-enter"]',function(){batchno=$(this).closest(".btn-list").data("batchno");var e=$(this).parents(".code-item").data("name");e=escape(e).toLocaleLowerCase().replace(/%u/gi,"\\u"),e=e.replace(/\\/g,"/"),$.get("/api/v1/qr/GetQrBatch",{batchNo:batchno}).done(function(t){ajaxResHandle(t,function(){var a=t.context.fileSecret;if(a){var s=location.origin+"/html/qr/download.html?batchNo="+batchno+"&codeName="+e+"&orgId="+obj.orgId;$(".copy-text").html('<p class="linkurl">'+s+'</p>\n                        <p class="pdk linkurl">查看文件密钥:<span class="secret"></span>'+a+"</p> ").removeClass("text-center"),$("[data-cj=shareBtn]").show()}else $(".copy-text").html("此文件暂不支持下载").addClass("text-center"),$("[data-cj=shareBtn]").hide()})}),$(".pop").removeClass("invisible").children(".download").removeClass("invisible").siblings().addClass("invisible"),$(".backspace").removeClass("invisible"),isScrollable()}),$('[data-click="backspace"]').click(function(){$(this).addClass("invisible").siblings().addClass("invisible").parent(".pop").addClass("invisible"),isScrollable()}),$("[data-cj=shareBtn]").click(function(){$("#shareBtn").trigger("click")});var clipboard=new Clipboard("#shareBtn");clipboard.on("success",function(e){$(".pop").addClass("invisible"),isScrollable(),e.clearSelection(),alert("复制成功！")}),clipboard.on("error",function(e){alert("复制失败，请重试")}),$("#code-list").on("click",'[data-click="compile-enter"]',function(){if($(this).data("status")>3)alert("已激活码包不可修改");else{$(".add-title").text("编辑"),obj.batchNo=$(this).closest(".btn-list").data("batchno"),obj.productId=$(this).data("pid");var e=$(this).parents(".code-top").children().children();obj.numTxt=e.children(".num").text(),obj.nameTxt=$(this).parents(".code-item").data("name"),obj.relevance=e.children(".name").text(),$("#relevance-product li").removeClass("active"),$("#relevance-product li").each(function(){$.trim($(this).text())==$.trim(obj.relevance)&&$(this).addClass("active")}),obj.rulesTxt=e.children(".rules").text(),"条"===obj.rulesTxt?obj.packageType=0:obj.packageType=1,obj.status=$(this).parent(".right").data("status"),obj.countTxt=e.children(".count").text(),obj.timeTxt=e.children(".time").text(),obj.personTxt=e.children(".person").text(),obj.withPinPasswd=e.children(".captcha").text(),obj.pinPasswdLength=$(this).parents(".code-top").children().children(".pin").data("pin"),obj.remarksTxt="无"==e.children(".remarks").text()?"":e.children(".remarks").text(),obj.domain=$(this).parents(".code-item").data("domain"),compile(obj)}}),document.addEventListener("click",function(e){e=e||window.event;var t=$(".listener");t.is(e.target)||0!==t.has(e.target).length||t.children(".dropdown-list").css("display","none"),e.stopPropagation()}),$(".add-code,.download").click(function(e){e.stopPropagation()}),$(".add-btns").on("click",'[data-click="compile-btn"]',function(){obj.nameText=$('input[name="name"]').val(),obj.packageType="盒"===$(".rules-text").text()?1:0,obj.remarksTxt=$('textarea[name="remarks"]').val(),obj.productId=$(".relevance-id").text(),$.post("/api/v1/qr/UpdateQrBatch",{batchNo:obj.batchNo,productId:obj.productId,status:obj.status,name:obj.nameText,orgId:obj.orgId,packageType:obj.packageType,memo:obj.remarksTxt,domain:obj.domain}).done(function(e){ajaxResHandle(e,function(){$("#code-list").html(""),dropLoadInit()})}),$(".add-code").addClass("invisible").parents(".pop").addClass("invisible"),isScrollable()}),$("#code-list").on("click",'[data-clicl="log-enter"]',function(){var e=$(this).closest(".btn-list").data("batchno");$.get("/api/v1/qr/GetQrBatchProcess",{batchNo:e,qrcode:""}).done(function(e){ajaxResHandle(e,function(){$("#log-list").html(tmpl("template_loglist",e.context))})}),$(".pop").removeClass("invisible").children(".log-pop").removeClass("invisible").siblings().addClass("invisible"),isScrollable()}),$('[data-click="return"]').click(function(){$(".log-pop").addClass("invisible").parents(".pop").addClass("invisible"),isScrollable()}),$(".menu_c div").on("click",function(e){var t=e.target,a=$(t);a.parent(".menu_c").hasClass("disabled")||a.hasClass("j_active")||("no_c"===a.attr("class")?isNecessary(withPinPasswd=!1):"yes_c"===a.attr("class")&&isNecessary(withPinPasswd=!0),a.addClass("j_active"),a.siblings().removeClass("j_active"))}),$('[data-click="relevance"]').click(function(){$(this).children(".dropdown-list").toggle()}),$('[data-click="relevance"]').on("click","li",function(){$(this).addClass("active").siblings().removeClass("active"),$(".relevance-name").hasClass("c-6")||($(".relevance-name").addClass("c-6"),$(".rules-text").addClass("c-6")),$(".rules-text").text($(this).data("type")),$(this).parents(".import").children(".relevance-name").text($(this).text()),$(this).parents(".import").children(".relevance-id").text($(this).data("productid"))}),$('[data-click="cancel-btn"]').click(function(){$(".pop").addClass("invisible").children(".void-code").addClass("invisible"),isScrollable()}),$(".form-group .code-check").click(function(){$(this).hasClass("disabled")||($(".code-check").removeClass("checked").children(".check").attr("checked",!1),$(this).addClass("checked").children(".check").attr("checked",!0))}),$('[data-click="product-qr-batch"]').click(function(){$(this).siblings(".nav-item").children(".dropdown-list").css("display","none"),$(this).children(".dropdown-list").toggle()}),getproductList(),$(".nav-item").on("click",'li[data-click="product"]',function(){$(this).addClass("active").siblings().removeClass("active"),productId=$(this).data("pid"),obj.productId=productId,""==productId?(console.log($(this).closest(".dropdown-list").siblings(".text")),$(this).closest(".dropdown-list").siblings(".text").text("按产品")):$(this).closest(".dropdown-list").siblings(".text").text($(this).text()),mainData.data.productId=productId,$("#code-list").html(""),dropLoadInit()}),$('[data-click="time-qr-batch"]').click(function(){$(this).siblings(".nav-item").children(".dropdown-list").css("display","none"),$(this).children(".dropdown-list").toggle()}),$('[data-click="time-qr-batch"]').on("click","li",function(){$(this).addClass("active").siblings().removeClass("active");var e=moment().valueOf().toString(),t="",a="";switch($(this).index()){case 0:t=moment().startOf("week").valueOf().toString(),a=e,$(this).closest(".dropdown-list").siblings(".text").text($(this).text());break;case 1:t=moment().startOf("month").valueOf().toString(),a=e,$(this).closest(".dropdown-list").siblings(".text").text($(this).text());break;case 2:t=moment().subtract(1,"month").startOf("month").valueOf().toString(),a=moment().startOf("month").valueOf().toString(),$(this).closest(".dropdown-list").siblings(".text").text($(this).text());break;case 3:t=moment().startOf("quarter").valueOf().toString(),a=e,$(this).closest(".dropdown-list").siblings(".text").text($(this).text());break;case 4:t="",a="",$(this).closest(".dropdown-list").siblings(".text").text("按时间");break;default:alert("数据错误请刷新!")}obj.beginTime=t,obj.endTime=a,mainData.data.beginTime=t,mainData.data.endTime=a,$("#code-list").html(""),dropLoadInit()}),$('[data-click="status-qr-batch"]').click(function(){$(this).siblings(".nav-item").children(".dropdown-list").css("display","none"),$(this).children(".dropdown-list").toggle()}),$(".nav-item").on("click",'[data-click="status"]',function(){$(this).addClass("active").siblings().removeClass("active");var e=$(this).data("code");""===e?(status="",$(this).closest(".dropdown-list").siblings(".text").text("按状态")):($(this).closest(".dropdown-list").siblings(".text").text($(this).text()),status=parseInt(e,10)),obj.status=status,mainData.data.status=status,$("#code-list").html(""),dropLoadInit()});var dropLoad=$(".code-content").dropload({scrollArea:window,autoLoad:!0,distance:10,loadDownFn:function(e){$.ajax(mainData).done(function(t){ajaxResHandle(t,render,[e])}).fail(function(t,a){e.lock(),e.noData(),e.resetload(),$(".dropload-noData").html('<div class="dropload-error">加载出错<br>点我重试</div>'),$(".dropload-error").off().click(function(){dropLoad.noData(!1),dropLoad.unlock(),dropLoad.resetload()})})}});$(".pop").click(function(e){e.stopPropagation();var t=$(".pop>div");t.is(e.target)||0!==t.has(e.target).length||$(".pop").addClass("invisible"),isScrollable()});