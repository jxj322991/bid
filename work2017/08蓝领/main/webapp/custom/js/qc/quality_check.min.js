var result="";if(isWeixin){var scanQRCode=function(){wx.scanQRCode({needResult:1,scanType:["qrCode","barCode"],success:function(t){if(-1!==(result="https://qrtest.cjiot.cc/?c=ODMbu7ujy8B2wGMU9aWETWpTg9").indexOf(",")&&(result=result.split(",")[1].replace(/^\\s|\\s$/g,"")),console.log(result),urlReg.test(result)){var e=/https?:\/\/.+?\.(tbul.cn|cjiot.cc)\/\?c=(.+)/gi;if(e.test(result))result=result.replace(e,function(t,e,n){return n});else{var n=result.lastIndexOf("/");-1!==n&&(result=result.slice(n+1))}}"scan"!==result.substring(0,4)&&""!==result&&($(".scan-content").addClass("invisible"),qualityControl())}})},qualityControl=function(){"scan"!==result.substring(0,4)&&""!==result&&$.post("/api/v1/qr/QualityControl",{qrcode:result}).done(function(t){1===t.code?($(".content").removeClass("invisible").siblings(".no-scan").addClass("invisible"),$(".activating-content").removeClass("invisible"),showOrg(),ajaxResHandle(t,function(){$("#batchinfo-info").html(tmpl("template_batchinfo",t.context)),$("#formal").html(tmpl("template_formal",t.context))})):alert(t.msg)})},showOrg=function(){var t=$(".product-content").data("batchno");$.get("/api/v1/qr/GetQrBatchProcess",{batchNo:t,qrcode:result,type:"QualityControl"},function(t){ajaxResHandle(t,function(){var e=t.context.batchProcess;$(".production-bg").data("status")>=4&&0!==e.length&&$("#batch-process").html(tmpl("template_process",t.context))})})},urlReg=/^https?:\/\/(([a-zA-Z0-9_-])+(\.)?)*(:\d+)?(\/((\.)?(\?)?=?&?[a-zA-Z0-9_-](\?)?)*)*$/i;wx.ready(function(){scanQRCode()}),$(".activating-content").on("click",'[data-click="activation-btn"]',function(){console.log("激活本批次"),$(".activation-content").removeClass("invisible"),$(".activating-content").addClass("invisible");var t=$(".product-content").data("batchno");$.post("/api/v1/qr/ActivateQrBatch",{batchNo:t}).done(function(t){1===t.code?($(".activation-content").addClass("invisible"),$(".activating-content").removeClass("invisible"),qualityControl()):alert(msg)})}),$(".activating-content").on("click",'[data-click="again-activation"]',function(){scanQRCode()}),$("#scanQRCode").click(function(){scanQRCode()})}else document.head.innerHTML='<title>抱歉，出错了</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0"><link rel="stylesheet" type="text/css" href="https://res.wx.qq.com/open/libs/weui/0.4.1/weui.css">',document.body.innerHTML='<div class="weui_msg"><div class="weui_icon_area"><i class="weui_icon_info weui_icon_msg"></i></div><div class="weui_text_area"><h4 class="weui_msg_title">请在微信客户端打开链接</h4></div></div>';