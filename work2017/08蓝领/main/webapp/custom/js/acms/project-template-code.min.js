function getPlanByActivity(a,t){var e="",i=a.context||[],c=i.length,o=code_bag_data.data.start+c,n=a.context;if(code_bag_data.data.start=o,c>0)for(var s=0,d=i.length;s<d;s++)e+='<div class="card clearfix">\n            <div class="card-left">\n                <p class="plan">投放计划：<span class="paln-name">'+n[s].name+'</span></p>\n                <p class="l-p">投放区域：<span class="region-name">'+function(a){var t="";if((a=a||[]).length>0)for(var e=0,i=a.length;e<i;e++)t+=locationObj[a[e]]?locationObj[a[e]].short_name+" ":"";return t}(n[s].details[0].provinces)+'</span></p>\n                <p class="l-p">投放时间：<span class="interval">'+n[s].details[0].time.begin+"-"+n[s].details[0].time.end+'</span></p>\n                <p class="l-p">关联码包：<span class="batch-num">'+function(a){var t="";if(a.length>0)for(var e=0,i=a.length;e<i;e++)t+=a[e].name+" ";return t}(n[s].batches)+'</span></p>\n                <p class="l-p">关联活动：<span class="activity-name">'+n[s].activityId+'</span></p>\n            </div>\n            <div class="card-right">\n                '+(1===n[s].status?'<img src="//saascore.oss-cn-beijing.aliyuncs.com/mobile/custom/img/acms/underway.png" class="underway-img">':"")+'\n                <ul class="operate-list">\n                    <li><a href="#modal-codepackage" data-cj="modal" class="operate-item" data-click="launch" data-planid="'+n[s].id+'">编辑</a></li>\n                    <li>\n                    <a href="#modal-codepackage" data-cj="modal" class="operate-item" data-click="rules" data-planid="'+n[s].id+'" data-limitperday="'+n[s].limitPerDay+'" data-rewardspercode="'+n[s].rewardsPerCode+'">扫码规则</a>\n                    </li>\n                    <li><a href="#modal-codepackage" data-cj="modal" class="operate-item" data-click="offline" data-planid="'+n[s].id+'">下线</a></li>\n                    \x3c!--<li><a href="#modal-codepackage" data-cj="modal" class="operate-item log" data-click="log" data-batchno="'+n[s].id+'">日志</a></li>--\x3e\n                </ul>\n            </div>\n        </div>';else t.lock(),t.noData(),console.log("锁定");$("#codePackage .card-list").append(e),t.resetload(),0===code_bag_data.data.start&&($(".dropload-down ").hide(),$("#codePackage .card-list").html('<img src="//saascore.oss-cn-beijing.aliyuncs.com/mobile/custom/img/acms/nodata.png" alt="" class="nodata-img">\n<div class="nodata-info">暂无数据</div>'))}function batchRender(){$(".show-batch").html(tmpl("template_showbatch",{batchParamsObj:batchParamsObj}))}function rendering(){$(".show-region").html(tmpl("template_showregion",{provinceObj:provinceObj}))}function dropLoadInit(){code_bag_data.data.start=0,$(".dropload-down").show(),dropLoad_code.noData(!1),dropLoad_code.unlock(),dropLoad_code.resetload()}var provinceKey="",provinceHtml="",provinceName="",provinceObj={provinces:{}},cityKey="",cityHtml="",cityName="",provinceCode="",batchParamsObj={pids:{}};for(var key in locationObj)provinceHtml+='<li data-cj="getCityList" data-province="'+key+'">'+locationObj[key].short_name+"</li>";$("#provinceList").html(provinceHtml),$('[data-cj="getCityList"]').click(function(a){if(a.stopPropagation(),!$(this).hasClass("active")){$(".launch-pop").scrollTop(0),$(this).addClass("active").siblings().removeClass("active"),provinceObj.provinces[$(this).data("province")]||(provinceObj.provinces[$(this).data("province")]={status:0,short_name:$(this).text(),cities:{}}),rendering(),cityHtml="";var t=$(this).data("province");for(var e in locationObj[t].cities)cityHtml+='<li class="batch-item" data-city="'+e+'">'+locationObj[t].cities[e].name+"</li>";cityHtml='<li class="batch-item" data-city="all">全选</li>'+cityHtml,$("#cityList").html(cityHtml).on("click","[data-city]",function(a){a.stopPropagation(),"all"===$(this).data("city")?$(this).hasClass("checked")||($("[data-city]").addClass("checked"),provinceObj.provinces[$("[data-cj=getCityList].active").data("province")].status=1,provinceObj.provinces[$("[data-cj=getCityList].active").data("province")].cities={},rendering()):$(this).hasClass("checked")||($(this).addClass("checked"),provinceObj.provinces[$("[data-cj=getCityList].active").data("province")].status=0,provinceObj.provinces[$("[data-cj=getCityList].active").data("province")].cities[$(this).data("city")]=$(this).text(),rendering())})}}),$(".show-region").on("click","[data-province]",function(){provinceObj.provinces[$(this).data("province")].status=0,rendering()}),$(".show-region").on("click","[data-city]",function(){delete provinceObj.provinces[$(this).data("provincecode")].cities[$(this).data("city")],rendering(),console.log(provinceObj)}),$("#modal-codepackage").on("shown.cj.modal",function(a){var t=this,e=a.relatedTarget;e||alert("触发元素不正确"),$("html").addClass("html-unscrollable");var i=$(this);$(this).find("input,[data-cj=relevance]").click(function(){var a=i.find("input,[data-cj=relevance]").not(this);a.find(".dropdown-list").addClass("invisible"),a.find(".dropdown-icon").removeClass("rotate")});var c=$(e),o=c.data("planid")||null,n=void 0,s=void 0;c.hasClass("add-code-btn")?($(".launch-pop").on("focus",".flatpickr-mobile",function(){$(this).removeClass("before-content").siblings().removeClass("before-content")}),$(".launch-pop").on("blur",".flatpickr-mobile",function(){$(this).addClass("before-content").siblings().addClass("before-content")}),n=flatpickr("#planBeginTime",{mode:"single",enableTime:!0,time_24hr:!0,defaultHour:24,defaultMinute:0,locale:"zh",dateFormat:"Y-m-d H:i",defaultDate:"",disableMobile:!1,plugins:[new confirmDatePlugin({confirmText:"确认 ",showAlways:!0,theme:"light"})],onChange:function(a,t,e){s.set("minDate",a[0])}}),s=flatpickr("#planEndTime",{mode:"single",enableTime:!0,time_24hr:!0,defaultHour:24,defaultMinute:60,locale:"zh",dateFormat:"Y-m-d H:i",defaultDate:"",disableMobile:!1,plugins:[new confirmDatePlugin({confirmText:"确认 ",showAlways:!0,theme:"light"})],onChange:function(a,t,e){n.set("maxDate",a[0])}}),$(".launch-pop").removeClass("invisible")):$.get("/api/v1/qr/GetPlan",{plan_id:o}).done(function(a){ajaxResHandle(a,function(){var e="."+c.data("click")+"-pop";if($(e).removeClass("invisible"),"launch"===c.data("click")){$("#planName").val(a.context.name),n=flatpickr("#planBeginTime",{mode:"single",enableTime:!0,time_24hr:!0,defaultHour:24,defaultMinute:0,locale:"zh",dateFormat:"Y-m-d H:i",defaultDate:a.context.details[0].time.begin,disableMobile:!1,plugins:[new confirmDatePlugin({confirmText:"确认 ",showAlways:!0,theme:"light"})],onChange:function(a,t,e){s.set("minDate",a[0])}}),s=flatpickr("#planEndTime",{mode:"single",enableTime:!0,time_24hr:!0,defaultHour:24,defaultMinute:0,locale:"zh",dateFormat:"Y-m-d H:i",defaultDate:a.context.details[0].time.end,disableMobile:!1,plugins:[new confirmDatePlugin({confirmText:"确认 ",showAlways:!0,theme:"light"})],onChange:function(a,t,e){n.set("maxDate",a[0])}});var i=a.context.details[0].provinces||[],d=a.context.details[0].cities||[];if(i.length>0)for(var l=0,r=i.length;l<r;l++)locationObj[i[l]]&&(provinceObj.provinces[i[l]]={cities:{},status:1,short_name:locationObj[i[l]].short_name});if(console.log(provinceObj),d.length>0)for(var p=0,h=d.length;p<h;p++)provinceCode=d[p].substring(0,2)+"0000",provinceObj.provinces[provinceCode]||(provinceObj.provinces[provinceCode]={cities:{},status:0,short_name:locationObj[provinceCode].short_name}),provinceObj.provinces[provinceCode].cities[d[p]]=locationObj[provinceCode].cities[d[p]].name;console.log(provinceObj),rendering();var m=a.context.batches||[];if(m.length>0){batchParamsObj.pids.temp={batches:{}};for(var v=0,b=m.length;v<b;v++)batchParamsObj.pids.temp.batches[m[v].batchNo]=m[v].name;console.log(batchParamsObj),batchRender()}}$(t).find('[data-cj="offLine"]').off().click(function(){$.post("/api/v1/qr/OfflinePlan",{plan_id:o}).done(function(a){ajaxResHandle(a,function(){$("#codePackage .card-list").html(""),dropLoadInit(),$("[data-dismiss=modal]").trigger("click")})})}),"rules"===c.data("click")&&($('[name="limit_per_day"]').val(a.context.limitPerDay),$('[name="rewards_per_code"]').val(a.context.rewardsPerCode),$('.rules-pop [data-click="compile-btn"]').off().click(function(){var a={number:/^-?(\d*\.)?\d+(e[-+]?\d+)?$/i,integer:/^-?\d+$/},e=$('[name="limit_per_day"]').val();return e&&!a.integer.test(e)?($('[name="limit_per_day"]').focus(),void $(t).find(".validate-error").html("只能输入数字！")):e&&e<0?($('[name="limit_per_day"]').focus(),void $(t).find(".validate-error").html("概率不能小于0！")):(e=$('[name="rewards_per_code"]').val())&&!a.integer.test(e)?($('[name="rewards_per_code"]').focus(),void $(t).find(".validate-error").html("只能输入数字！")):e&&e<0?($('[name="rewards_per_code"]').focus(),void $(t).find(".validate-error").html("概率不能小于0！")):void $.post("/api/v1/qr/UpdatePlanParam",{plan_id:o,limit_per_day:$('[name="limit_per_day"]').val(),rewards_per_code:$('[name="rewards_per_code"]').val()}).done(function(a){ajaxResHandle(a,function(){$("#codePackage .card-list").html(""),dropLoadInit(),$("[data-dismiss=modal]").trigger("click")})})}))})}),$('.launch-pop [data-click="compile-btn"]').click(function(){var a=this;if(!$(this).hasClass("disabled")){var t={pids:[],batches:[],cities:[],provinces:[]};if($.trim($("#planName").val()).length<=0)return $("#planName").focus(),void i.find(".validate-error").html("计划名称不能为空");if(""!=$.trim($("#planBeginTime").val())&&""!=$.trim($("#planEndTime").val())){if(t.name=$("#planName").val(),t.beginTime=n.formatDate(n.selectedDates[0],"Y-m-d H:i:00"),t.endTime=s.formatDate(s.selectedDates[0],"Y-m-d H:i:00"),console.log("开始"+t.beginTime+"结束"+t.endTime),!$.isEmptyObject(provinceObj.provinces))for(var e in provinceObj.provinces)if(1===provinceObj.provinces[e].status&&t.provinces.push(e),!$.isEmptyObject(provinceObj.provinces[e].cities))for(var c in provinceObj.provinces[e].cities)t.cities.push(c);if(batchParamsObj.pids&&!$.isEmptyObject(batchParamsObj.pids))for(var d in batchParamsObj.pids)if(1==batchParamsObj.pids[d].status&&t.pids.push(d),batchParamsObj.pids[d].batches&&!$.isEmptyObject(batchParamsObj.pids[d].batches))for(var l in batchParamsObj.pids[d].batches)t.batches.push(l);console.log(t);var r={activity_id:activityId,plan:JSON.stringify(t)};o&&(r.plan_id=o),$(this).addClass("disabled"),setTimeout(function(){$(a).removeClass("disabled")},3e3),$.post("/api/v1/qr/UpdatePlan",r).done(function(a){ajaxResHandle(a,function(){$("#codePackage .card-list").html(""),dropLoadInit(),$("[data-dismiss=modal]").trigger("click")})})}else i.find(".validate-error").html("选择一个日期范围")}}),$(".show-batch").on("click","[data-pid]",function(){batchParamsObj.pids[$(this).data("pid")].status=0,batchParamsObj.pids[$(this).data("pid")].batches={},console.log(batchParamsObj),$("#pidList").find('[data-pid="'+$(this).data("pid")+'"]').removeClass("active"),$("#batchNoList").html(""),batchRender()}).on("click","[data-batchno]",function(){delete batchParamsObj.pids[$(this).data("productid")].batches[$(this).data("batchno")],console.log(batchParamsObj),$("#batchNoList").find('[data-batchno="'+$(this).data("batchno")+'"]').removeClass("checked"),batchRender()}),$.get("/api/v1/product/GetProductList",{start:0,size:300}).done(function(a){ajaxResHandle(a,function(){$("#pidList").html(""),$("#batchNoList").html("");var t=a.context.productList||[];if(t.length>0){for(var e=0,i=t.length;e<i;e++)$("#pidList").append('<li data-cj="getBatchList" data-pid="'+t[e].productId+'">'+t[e].name+"</li>");$("#pidList").append('<li data-cj="getBatchList" data-pid="1">芙蓉王</li><li data-cj="getBatchList" data-pid="1">硬玉溪</li>'),$("#pidList").on("click",'[data-cj="getBatchList"]',function(a){a.stopPropagation(),$(this).hasClass("active")||($(this).addClass("active").siblings().removeClass("active"),batchParamsObj.pids[$(this).data("pid")]||(batchParamsObj.pids[$(this).data("pid")]={status:0,name:$(this).text(),batches:{}}),console.log(batchParamsObj),$("#batchNoList").html(""),$.get("/func/qr/list/batch",{productId:$(this).data("pid"),page:1,size:200}).done(function(a){ajaxResHandle(a,function(){var t=a.data||[];if(t.length>0){for(var e=0,i=t.length;e<i;e++)$("#batchNoList").append('<li class="batch-item" data-batchno="'+t[e].batch.batchNo+'">'+t[e].batch.name+"</li>");$("#batchNoList").prepend('<li data-batchno="all">全选</li>').on("click","[data-batchno]",function(a){a.stopPropagation(),"all"===$(this).data("batchno")?$(this).hasClass("checked")||($("[data-batchno]").addClass("checked"),batchParamsObj.pids[$("#pidList [data-cj=getBatchList].active").data("pid")].status=1,batchParamsObj.pids[$("#pidList [data-cj=getBatchList].active").data("pid")].batches={},console.log(batchParamsObj),batchRender()):$(this).hasClass("checked")||($(this).addClass("checked"),batchParamsObj.pids[$('#pidList [data-cj="getBatchList"].active').data("pid")].status=0,batchParamsObj.pids[$('#pidList [data-cj="getBatchList"].active').data("pid")].batches[$(this).data("batchno")]=$(this).text(),console.log(batchParamsObj),batchRender())})}else $("#batchNoList").html("还没添加批次")})}))})}})})}).on("hidden.cj.modal",function(){$("html").removeClass("html-unscrollable"),provinceObj={provinces:{}},batchParamsObj={pids:{}},cityHtml="",$(".show-region").html(""),$(".show-batch").html(""),$(this).find("input").val(""),$(this).find("select").val("-1"),$(this).find(".validate-error").html(""),$("#modal-codepackage>div").addClass("invisible")}).on("click",'[data-cj="relevance"]',function(){var a=$(this).find(".dropdown-list");if(a.hasClass("invisible")){a.removeClass("invisible").prev().children(".dropdown-icon").addClass("rotate");var t=$.Event("open.cj.dropdown");a.trigger(t)}else{a.addClass("invisible").prev().children(".dropdown-icon").removeClass("rotate");var e=$.Event("close.cj.dropdown");a.trigger(e)}}),$(".form-group .code-check").click(function(){$(this).addClass("checked").siblings(".code-check").removeClass("checked")});var code_bag_data={url:"/api/v1/qr/GetPlanByActivity",method:"GET",data:{activity_id:activityId,start:0,size:10,status:1}},dropLoad_code=void 0,dropLoad_bol=!1;$('[data-target="#codePackage"]').on("click",function(){dropLoad_bol||(dropLoad_bol=!0,$("#codePackage .dropload-down").remove(),code_bag_data.data.start=0,dropLoad_code=$("#codePackage").dropload({scrollArea:window,autoLoad:!0,distance:10,loadDownFn:function(a){$.ajax(code_bag_data).done(function(t){ajaxResHandle(t,getPlanByActivity,[a])}).fail(function(t,e){a.lock(),a.noData(),a.resetload(),$("#notice ").html('<div class="dropload-error">加载出错<br>点我重试</div>'),$(".dropload-error").off().click(function(){dropLoad_code.noData(!1),dropLoad_code.unlock(),dropLoad_code.resetload()})})}}),$("#codePackage .card-list").html(""))});